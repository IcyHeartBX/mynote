---
title: (学习netty)Java的IO演进之路
categories: netty
tags:
  - netty
  - socket
  - java
  - 学习笔记
cover_picture: https://ws4.sinaimg.cn/large/006tNbRwgy1fw447bl60pj308u04kgli.jpg
date: 2018-10-10 14:59:15
---

# 一、Java的I/O演进之路

## 1、IO基础入门

BIO的缺点

- 没有数据缓冲区，I/O性能存在问题
- 没有c或c++中的channel的概念，只有输入输出流
- 同步阻塞式IO通信(BIO)通常会导致通信线程被长时间阻塞。
- 支持的字符集有限，硬件可移植性不好

### 1.1、Linux网络io模型简介

Linux内核将所有外部设备都看做一个文件来操作,一切皆文件。

Socket的操作也是一个文件操作，socketfd (file descriptor),描述符是一个数字，指向内核中的一个结构体(文件路径，数据区等一些属性)

Unix网络编程I/O模型分类

- 阻塞模型:最常用的就是阻塞模型，缺省情况下，所有文件操作都是阻塞的。进程空间调用recvfrom，系统一直等待，其系统调用直到数据包到达且被复制到应用进程的缓冲区中或者发生错误才返回。进程从调用recvfrom到返回整段事件都是被阻塞的，所以被称为：阻塞I/O模型。

- 非阻塞模型:`recvfrom`从应用层到内核的时候，如果缓冲区没有数据，就直接返回EWOULDBLOCK错误，一般都对非阻塞I/O模型进行轮询检查这个状态，看内核是不是有数据到来(轮训)。

  ![屏幕快照 2018-06-14 下午2.54.03](https://ws1.sinaimg.cn/large/006tNc79gy1fsarwl7wurj30uq0ysqcz.jpg)

- I/O多路复用模型:Linux提供select/poll，进程通过一个或多个fd传递给select或poll系统调用,阻塞在select操作上，这样select/poll可以帮我们侦测多个fd是否处于就绪状态。select/poll是顺序扫描fd是否就绪，支持的fd有限。linux还提供了epoll系统调用，epoll使用基于事件驱动方式代替顺序扫描，性能更高。当有fd就绪时，立即回调函数rollback

- 信号驱动I/O模型:首先开启套接口信号驱动I/O,非阻塞，生成一个sigio信号，通过信号通知应用程序调用recvfrom来读取数据。

  - 信号不是真正的异步
  - 信号驱动不适合TCP场景，TCP为双工，适合UDP场景
  - 参考：https://blog.csdn.net/a987073381/article/details/52201200

- 异步I/O:告知内核启动某个操做，让内核操作完通知我们。

  异步I/O和信号驱动模型的区别:信号驱动I/O由内核通知我们何时可以开始一个I/O操作，异步I/O模型由内核通知我们I/O何时操作已经完成。![屏幕快照 2018-06-14 下午2.56.44](https://ws3.sinaimg.cn/large/006tNc79gy1fsarwmknt5j30zi10849x.jpg)

如果想了解更多参考《UNIX网络变成》



### 1.2、I/O多路复用技术

Java NIO的核心类库多路复用器Selector就是基于epoll的多路复用技术实现。

在I/O编程过程中，当需要同时处理多个客户端请求时，可以利用多线程或I/O多路复用技术进行处理。

I/O多路复用技术通过把多个I/O的阻塞复用到同一个select的阻塞上，而使得系统在单线程的情况下可以同时处理多个客户端请求。

多路复用技术和普通的多线程多进程模型比有点:

系统开销小，线程和进程耗费的系统资源多，维护也困难。

I/O多路复用的主要应用场景:

- 服务器需要同时处理多个处于监听状态或者多个连接状态的套接字；
- 服务器需要同时处理多种网络协议的套接字

目前支持I/O多路复用select、pselect、poll、epoll



epoll相对于select的优点:

- 最大fd不受限制
- I/O效率不会随着fd数目的增加而线性下降
- 使用mmap加速内核于用户空间的消息传递。
- epoll的API更加简单





## 2、Java的I/O演进

Java1.4提供了NIO类库

JavaNIO主要的类和接口:

- 进行异步I/O操作的缓冲区ByteBuffer等
- 进行异步I/O操作的管道Pipe
- 进行各种I/O操作(异步或者同步)的Channel,包括ServerSocketChannel和SocketChannel；
- 多种字符集的编码能力和解码能力。
- 实现非阻塞I/O操作的多路复用器selector;
- 基于流行的perl实现的正则表达式类库；
- 文件通道FileChannel



新的NIO类库的提供，极大地促进了基于Java的异步非阻塞编程的发展和应用，但是，它依然有不完善的地方，特别是对文件系统的处理能力仍显不足，主要问题如下：

- 没有统一的文件属性(例如，读写权限)
- API能力比较弱，例如目录的级联创建和递归遍历，往往需要自己实现
- 底层存储系统的一些高级API无法使用。
- 所有的文件操作都是同步阻塞调用，不支持异步文件读写操作。



jdk1.7更新

- 提供能够批量获取文件属性的API,这些API具有平台无关性，不与特性的文件系统耦合，另外还提供了标准文件系统的SPI,供哥哥服务提供商扩展实现。
- 提供AIO功能，支持基于文件的异步I/O操作和针对网络套接字的异步操作；
- 完成JSR-51定义的通道功能，包括对配置和多播数据报的支持率。